<script type="text/javascript" charset="utf-8">
  function startVideo() {
      var video = document.querySelector("#stream_container video");
      var context = new Dash.di.DashContext();
      var player = new MediaPlayer(context);
      player.startup();
      player.attachView(video);
      player.setAutoPlay(true);
      player.attachSource("http://<%= Settings.rtmp.server %>/dash/<%= @stream.user.username %>/index.mpd");
  }
</script>

<div class="row">
  <div class="col-xs-12 cold-md-12 col-lg-12">
    <h3><%= @stream.name %></h3>
    <p><%= @stream.description %></p>
  </div>
</div>

<div class="row">
  <!-- left --> 
  <div class="col-xs-12 col-sm-12 col-md-8 col-lg-8">

    <!-- player --> 
    <div class="row">
      <div class="col-xs-12">
        <div id="stream_container">
            <video style="height: 422px; width: 750px; display: block;" controls="true"></video>
        </div>
      </div>
    </div>

    <!-- stats --> 
    <div class="row">
      <div class="col-xs-12">
        <div class="well">
          <div>
            <strong>Viewers:</strong> <%= @stream.live ? @stream.viewers : 'Offline' %>
          </div>
          <div>
            <strong>Views:</strong> n/a
          </div>
        </div>
      </div>
    </div>

    <!-- info --> 
    <div class="row">
      <div class="col-xs-12">
        <div class="well">
          <%= @stream.body.html_safe %>
        </div>
      </div>
    </div>
  </div>

  <!-- right --> 
  <div class="col-xs-12 col-sm-12 cold-md-4 col-lg-4">

    <!-- chat -->
    <div class="row">
      <div class="col-xs-12">
        <div class="well">
          <div id="chat" class="chat">
          <% @stream.messages.limit(15).order(created_at: :desc).each do |message| %>
            <div class="message">
            <span class="name"><%= message.user.username %></span>
            <span class="body"><%= message.message %></span>
          </div>
          <% end %>
        </div>
      <% if user_signed_in? %>
        <div class="chat_input">
          <%= form_for @stream.messages.new do |f| %>
            <%= f.hidden_field :stream_id %>
            <%= f.text_field :message, class: 'form-control' %>
          <% end %>
        </div>
      <% else %>
        <div class="chat_input">
          Login or register to chat.
        </div>
      <% end %>
      </div>
    </div>

  </div>

</div>

<%= subscribe_to "/channel/#{@stream.id}" %>
<script type="text/javascript" charset="utf-8">
  $(document).ready(function(){

    startVideo();

    // fit the player
    $(window).resize(function() {
      var width = $("#stream_container").width();
      $("#stream").css({
          "width": width,
          "height": width*(9/16)
      });
      $("#stream_wrapper").css({
          "height": 'auto'
      });
    }).resize();
    setTimeout(function(){
      $(window).resize();
    }, 250);

    // scroll chat
    $('#chat').stop().animate({
      scrollTop: $("#chat")[0].scrollHeight
    }, 200);

    // chat
    setTimeout(function(){
      PrivatePub.subscribe("/channel/<%= @stream.id %>", function(data, channel) {
        $("#chat").append('<div class="message"><span class="name">' + data.username + '</span><span class="body">' + data.message + '</span></div>');
        $('#chat').stop().animate({
          scrollTop: $("#chat")[0].scrollHeight
        }, 500);
      });
    }, 1000);

    $('form#new_message').submit(function() {
      if ($('#message_message').val() != "") {
        var valuesToSubmit = $(this).serialize();
        $.ajax({
          type: "POST",
          url: $(this).attr('action'),
          data: valuesToSubmit,
          dataType: "HTML" 
        }).success(function(data){
          $('#message_message').val('');
        });
      }
      return false;
    });

  });

</script>